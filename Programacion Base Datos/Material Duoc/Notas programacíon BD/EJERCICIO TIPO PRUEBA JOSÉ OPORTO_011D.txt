/* LA EMPRESA PROFERICARDO SA, ESTÁ TRABAJANDO EN UN PLAN DE AHORRO
   Y AL ANALIZAR LOS SUELDOS DE LOS EMPLEADOS, PRECIBIERON QUE HAY
   DEPARTAMENTOS EN LA EMPRESA QUE TIENEN MUCHOS EMPLEADOS CONTRATADOS.
   Y AL MISMO TIEMPO HAY DEPARTAMENTOS QUE HAY MMUY POCOS EMPLEADOS
   PERO CON SUELDOS MUY ALTOS.
   
   PARA ELLO QUIEREN AUTOMATIZAR EL PROCESO DE ANALISIS DE SUELDOS,
   SE LE SOLICITA, QUE CADA MES SE GUARDEN EN LA TABLA
   ANALY_EMPLOYEES_SALARY EL NOMBRE DE CADA DEPARTAMENTO, LA CANTIDAD
   DE EMPLEADOS QUE ALLÍ TRABAJAN, EL SUELDO PROMEDIO, LA SUMA TOTAL 
   DE LOS SUELDOS PAGADOS EN ESE DEPARTAMENTO Y LA FECHA QUE SE EJECUTA
   EL PROCESO GUARDADO 'MES AÑO'.
   
   LOS MONTOS DE DINERO SE DEBEN GUARDAR CON FORMATO DE DINERO EN LA TABLA
   ANALY_EMPLOYEES_SALARY.
*/
CREATE TABLE ANALY_EMPLOYEES_SALARY(
    DEPARTMENT_NAME VARCHAR(50)
    , Q_EMPLOYEES NUMBER
    , AVG_SALARY VARCHAR(25)
    , TOTAL_SALARY VARCHAR(25)
    , FECHA_FOTO VARCHAR(25)
);

DECLARE 
    V_DEPARTMENT_NAME VARCHAR2(50);
    V_Q_EMPLOYEES NUMBER;
    V_AVG_SALARY NUMBER;
    V_TOTAL_SALARY NUMBER;
    V_FECHA_FOTO VARCHAR2(25);
BEGIN
    -- Eliminar los datos existentes en la tabla ANALY_EMPLOYEES_SALARY
    DELETE FROM ANALY_EMPLOYEES_SALARY;

    -- Calcular los datos de análisis por departamento
    FOR dept_rec IN (
        SELECT d.DEPARTMENT_NAME,
               COUNT(e.EMPLOYEE_ID) AS Q_EMPLOYEES,
               AVG(e.SALARY) AS AVG_SALARY,
               SUM(e.SALARY) AS TOTAL_SALARY
        FROM EMPLOYEES e
        INNER JOIN DEPARTMENTS d ON e.DEPARTMENT_ID = d.DEPARTMENT_ID
        GROUP BY d.DEPARTMENT_NAME
    )
    LOOP
        -- Asignar los valores calculados a las variables
        V_DEPARTMENT_NAME := dept_rec.DEPARTMENT_NAME;
        V_Q_EMPLOYEES := dept_rec.Q_EMPLOYEES;
        V_AVG_SALARY := dept_rec.AVG_SALARY;
        V_TOTAL_SALARY := dept_rec.TOTAL_SALARY;
        V_FECHA_FOTO := TO_CHAR(SYSDATE, 'MM YYYY');

        -- Insertar los resultados en la tabla ANALY_EMPLOYEES_SALARY
        INSERT INTO ANALY_EMPLOYEES_SALARY (DEPARTMENT_NAME, Q_EMPLOYEES, AVG_SALARY, TOTAL_SALARY, FECHA_FOTO)
        VALUES (V_DEPARTMENT_NAME, V_Q_EMPLOYEES, TO_CHAR(V_AVG_SALARY, 'FM$999,999,999.99'), TO_CHAR(V_TOTAL_SALARY, 'FM$999,999,999.99'), V_FECHA_FOTO);
    END LOOP;

    -- Confirmar los cambios
    COMMIT;
END;